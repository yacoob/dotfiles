# hadolint global ignore=DL3007,DL3041,DL3059,DL4006
# - 3007 - yes, I do want the `latest` :D
# - 3041 - no, I don't care about specific versions of the packages I'm installing
# - 3059 - I'm ok with consecutive `RUN`s; I squash the layers at the end regardless,
#          and during the build multiple `RUN` lines cache better
# - 4006 - podman doesn't support this :[

FROM fedora:latest AS common-builder
# Set up my user
ARG UID
ARG GID
ENV UID=${UID:-1000}
ENV GID=${GID:-1000}
RUN groupadd -g ${GID} yacoob \
  && useradd -l -u ${UID} -g ${GID} -m -s /usr/bin/zsh -G wheel yacoob \
  && passwd -d yacoob
# Install packages
RUN \
  dnf install --setopt=install_weak_deps=False -y \
    dnf-plugins-core \
    bat curl difftastic fd-find fzf git procps ripgrep sudo tealdeer unzip yq zsh \
  && for c in atim/bottom atim/lazygit atim/starship faramirza/gdu; do \
    dnf copr enable -y $c; \
  done \
  && dnf remove -y dnf-plugins-core \
  && dnf install --setopt=install_weak_deps=False -y gdu bottom starship \
  && dnf clean all
# The context should contain the entire repository.
ARG BOOTSTRAP=/tmp/conf-bootstrap
COPY --chown=yacoob:yacoob . ${BOOTSTRAP}
USER yacoob
WORKDIR /home/yacoob/.local/bin
# install eget
RUN curl https://zyedidia.github.io/eget.sh | sh


FROM common-builder AS base-builder
ARG BOOTSTRAP=/tmp/conf-bootstrap
USER yacoob
WORKDIR /home/yacoob
# Run chezmoi install script
RUN "${BOOTSTRAP}/install.sh" --promptDefaults \
  && rm -rf "${BOOTSTRAP}"
# start zsh so antidote can install plugins
RUN  script -qec '/usr/bin/zsh -is </dev/null' /dev/null


FROM base-builder AS devenv-builder
USER root
# Add more packages
RUN dnf install --setopt=install_weak_deps=False -y \
    direnv gcc gh just lazygit neovim nodejs-npm tmux \
  && dnf clean all
WORKDIR /home/yacoob/.local/bin
# install binaries via eget
RUN ./eget watchexec/watchexec -a musl.tar.xz _ -a '^b3' -a '^sha512' --to=/usr/local/bin
USER yacoob
# switch chezmoi to devenv flavour
RUN ./chezmoi init --promptBool dev-environment=true --apply


FROM fedora:latest AS common
# Set the environment
ENV SHELL=/usr/bin/zsh
ENV SSH_AUTH_SOCK=/home/yacoob/.ssh/agent.sock
ENV TERM=xterm-256color
ENV TZ='Europe/Dublin'
USER yacoob
ENTRYPOINT ["/usr/bin/zsh"]
LABEL maintainer="yacoob@ftml.net"
# Add devcontainer options
# https://containers.dev/implementors/reference/#labels
LABEL devcontainer.metadata='{ \
  "remoteUser": "yacoob", \
  "containerUser": "yacoob", \
  "securityOpt": ["label=disable"] \
}'


FROM common AS base
COPY --from=base-builder / /


FROM common AS devenv
COPY --from=devenv-builder / /
